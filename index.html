<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>L·ªÖ h·ªôi l·ªìng ƒë√®n 3D üéê</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        background: linear-gradient(to bottom, #001f3f 0%, #000814 100%);
        overflow: hidden;
        font-family: "Segoe UI", sans-serif;
      }

      .scene {
        width: 100%;
        height: 100%;
        perspective: 1200px;
        position: relative;
        overflow: hidden;
      }

      .scene.start {
        animation: sceneZoom 2s ease forwards;
      }
      @keyframes sceneZoom {
        0% {
          transform: scale(0.9);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .moon {
        position: fixed;
        top: 4%;
        right: 4%;
        width: 140px;
        height: 140px;
        background: radial-gradient(
          circle,
          #fffbe8 0%,
          #f7e7a8 40%,
          #e5d37a 70%,
          transparent 100%
        );
        border-radius: 50%;
        box-shadow: 0 0 20px 10px rgba(255, 250, 220, 0.7),
          0 0 40px 20px rgba(255, 250, 220, 0.5);
        animation: moonGlow 4s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }
      @keyframes moonGlow {
        0%,
        100% {
          box-shadow: 0 0 20px 10px rgba(255, 250, 220, 0.7),
            0 0 40px 20px rgba(255, 250, 220, 0.5);
        }
        50% {
          box-shadow: 0 0 30px 15px rgba(255, 250, 220, 0.8),
            0 0 60px 25px rgba(255, 250, 220, 0.6);
        }
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        opacity: 0.8;
        animation: twinkle 2s infinite ease-in-out;
        z-index: 0;
        pointer-events: none;
      }
      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 1;
        }
      }

      .lantern-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transform-style: preserve-3d;
        transform: translateZ(-800px);
        z-index: 2;
        transition: transform 1s cubic-bezier(0.22, 0.9, 0.35, 1);
      }

      .lantern-wrapper {
        position: absolute;
        transform-style: preserve-3d; /* keep pointer-events none so clicks go to img/lantern */
        pointer-events: none;
      }

      .lantern {
        width: 400px;
        height: auto;
        position: relative;
        animation: floatUp linear infinite;
        transform-origin: center bottom;
        cursor: pointer;
        transition: transform 0.4s ease, box-shadow 0.4s ease;
        pointer-events: none;
        backface-visibility: hidden;
        animation-play-state: paused;
      }

      .lantern img {
        width: 100%;
        display: block;
        pointer-events: auto;
        user-select: none;
        -webkit-user-drag: none;
      }

      @keyframes floatUp {
        0% {
          transform: translateY(0) translateX(0) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        100% {
          transform: translateY(-110vh) translateX(50px) rotate(5deg);
          opacity: 0;
        }
      }

      .hanger {
        position: absolute;
        bottom: 0;
        left: 51%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .string {
        width: 2px;
        height: 50px;
        background: #f5f5f5;
      }
      .frame {
        width: 60px;
        height: 60px;
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.4);
        animation: swing 2.5s ease-in-out infinite alternate;
        cursor: pointer;
        margin-top: 0;
      }
      .frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      @keyframes swing {
        from {
          transform: rotateZ(-6deg);
        }
        to {
          transform: rotateZ(6deg);
        }
      }

      /* --- Popup l·ªùi ch√∫c --- */
      .popup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0);
        display: flex;
        justify-content: center;
        align-items: center;
        visibility: hidden;
        opacity: 0;
        transition: all 0.35s ease;
        z-index: 10010;
      }

      .popup.active {
        visibility: visible;
        opacity: 1;
        background: rgba(0, 0, 0, 0.7);
      }

      .popup-content {
        background: linear-gradient(145deg, #fff8e1, #ffe0b2);
        color: #5d4037;
        padding: 30px 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 0 30px rgba(255, 223, 186, 0.8),
          0 0 10px rgba(255, 255, 255, 0.6) inset;
        animation: popupFadeIn 0.4s ease;
        position: relative;
      }

      .popup-content h2 {
        font-size: 24px;
        margin-bottom: 12px;
        color: #d17b00;
        text-shadow: 0 0 6px rgba(255, 202, 40, 0.8);
      }

      .popup-content p {
        font-size: 18px;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .popup-content button {
        background: linear-gradient(to right, #ffb74d, #ff9800);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
      }

      .popup-content button:hover {
        background: linear-gradient(to right, #ffa726, #f57c00);
        transform: scale(1.05);
      }

      @keyframes popupFadeIn {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* --- Popup h√¨nh ·∫£nh --- */
      .image-popup .popup-content {
        background: transparent;
        padding: 0;
        box-shadow: none;
        max-width: 90vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: popupFadeIn 0.4s ease;
      }

      .image-popup .popup-content img {
        max-width: 90vw;
        max-height: 75vh;
        border-radius: 15px;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
        margin-bottom: 15px;
      }

      .image-popup .popup-content button {
        background: linear-gradient(to right, #ffb74d, #ff9800);
        color: white;
        border: none;
        padding: 8px 18px;
        border-radius: 25px;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
      }

      .image-popup .popup-content button:hover {
        background: linear-gradient(to right, #ffa726, #f57c00);
        transform: scale(1.05);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20000;
        transition: opacity 1s ease;
      }
      .overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
      .countdown {
        font-size: 100px;
        color: white;
        font-weight: bold;
        animation: pop 0.8s ease;
      }
      @keyframes pop {
        0% {
          transform: scale(0);
          opacity: 0;
        }
        50% {
          transform: scale(1.3);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* dim khi popup active (separate element to avoid interfering with click detection) */
      .modal-dim {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10005;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .modal-dim.show {
        opacity: 1;
        pointer-events: auto;
      }

      /* highlight selected */
      .lantern.selected img {
        filter: drop-shadow(0 0 18px gold) brightness(1.15);
        transition: filter 0.25s ease;
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="overlay">
      <div class="countdown" id="countdown">3</div>
    </div>

    <div class="scene">
      <div class="moon"></div>
      <div class="lantern-container" id="lantern-container"></div>
    </div>

    <div id="modal-dim" class="modal-dim"></div>

    <div class="popup" id="popup">
      <div class="popup-content">
        <h2>L·ªùi ch√∫c Trung Thu üéê</h2>
        <p id="popup-text"></p>
        <button onclick="closePopup()">ƒê√≥ng</button>
      </div>
    </div>

    <div class="popup image-popup" id="image-popup">
      <div class="popup-content">
        <img id="popup-image" src="" alt="H√¨nh Trung Thu" />
        <button onclick="closeImagePopup()">ƒê√≥ng</button>
      </div>
    </div>

    <audio id="bg-music">
      <source src="lunar.mp3" type="audio/mpeg" />
    </audio>

    <script>
      const lanternContainer = document.getElementById("lantern-container");
      const popup = document.getElementById("popup");
      const popupText = document.getElementById("popup-text");
      const imagePopup = document.getElementById("image-popup");
      const popupImage = document.getElementById("popup-image");
      const modalDim = document.getElementById("modal-dim");

      // canvas ·∫©n ƒë·ªÉ ki·ªÉm tra pixel
      const hitCanvas = document.createElement("canvas");
      const hitCtx = hitCanvas.getContext("2d");

      // stars
      for (let i = 0; i < (window.innerWidth < 480 ? 50 : 100); i++) {
        const star = document.createElement("div");
        star.className = "star";
        const size = Math.random() * 2 + 1;
        star.style.width = size + "px";
        star.style.height = size + "px";
        star.style.top = Math.random() * 100 + "%";
        star.style.left = Math.random() * 100 + "%";
        star.style.animationDelay = Math.random() * 2 + "s";
        document.body.appendChild(star);
      }

      const messages = [
        "Ch√∫c Trung Thu vui v·∫ª üåï‚ú®",
        "Mong nh·ªØng ƒëi·ªÅu b√¨nh an s·∫Ω b√™n b·∫°n üå∏",
        "Trung Thu ng·ªçt ng√†o üç¨",
        "∆Ø·ªõc nguy·ªán bay cao üïäÔ∏è",
        "TrƒÉng r·∫±m soi s√°ng, ni·ªÅm vui ng·∫≠p tr√†n üåù",
        "ƒê√™m h·ªôi lung linh ‚ú®",
        "Ch√∫c b·∫°n m·ªçi ƒëi·ªÅu t·ªët ƒë·∫πp üéâ",
      ];

      const sampleImages = [
        "1.jpg",
        "2.png",
        "3.jpg",
        "4.jpg",
        "5.jpg",
        "6.jpg",
      ];

      const isMobile = window.innerWidth <= 480;
      const lanternCount = isMobile ? 70 : 100;
      const baseRadius = isMobile ? 400 : 800;
      const maxRadius = isMobile ? 600 : 1600;

      // t·∫°o lanterns (ƒê√É S·ª¨A L·ªñI)
      for (let i = 0; i < lanternCount; i++) {
        // T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng ·∫£nh trong b·ªô nh·ªõ ƒë·ªÉ t·∫£i tr∆∞·ªõc
        const lanternImgAsset = new Image();

        // S·ª± ki·ªán onload s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t KHI ·∫£nh ƒë√£ t·∫£i xong
        lanternImgAsset.onload = () => {
          // --- B√ÇY GI·ªú T·∫§T C·∫¢ LOGIC T·∫†O L·ªíNG ƒê√àN S·∫º N·∫∞M TRONG ƒê√ÇY ---

          const wrapper = document.createElement("div");
          wrapper.className = "lantern-wrapper";

          const lantern = document.createElement("div");
          lantern.className = "lantern";

          // D√πng ·∫£nh ƒë√£ t·∫£i xong (lanternImgAsset) thay v√¨ t·∫°o m·ªõi
          const lanternImg = lanternImgAsset;
          lantern.appendChild(lanternImg);

          const angle = Math.random() * 2 * Math.PI;
          const radius = baseRadius + Math.random() * (maxRadius - baseRadius);
          const x = Math.cos(angle) * radius;
          const z = Math.sin(angle) * radius;
          const y = Math.random() * window.innerHeight;

          wrapper.style.transform = `translate3d(${x}px, ${y}px, ${z}px)`;
          wrapper.style.zIndex = Math.floor(z + maxRadius);

          lantern.style.animationDuration = 10 + Math.random() * 15 + "s";

          const scale = isMobile
            ? 0.8 + Math.random() * 1.1
            : 0.6 + Math.random() * 1.3;
          lantern.style.transform = `scale(${scale})`;

          lantern.dataset.message =
            messages[Math.floor(Math.random() * messages.length)];

          // hanger (30%)
          if (Math.random() < 0.3) {
            const hanger = document.createElement("div");
            hanger.className = "hanger";

            const string = document.createElement("div");
            string.className = "string";

            const frame = document.createElement("div");
            frame.className = "frame";

            const img = document.createElement("img");
            img.src =
              sampleImages[Math.floor(Math.random() * sampleImages.length)];
            frame.appendChild(img);

            frame.addEventListener("click", (e) => {
              e.stopPropagation();
              popupImage.src = img.src;
              imagePopup.classList.add("active");
            });

            hanger.appendChild(string);
            hanger.appendChild(frame);
            lantern.appendChild(hanger);

            lantern.dataset.hasFrame = "true";
          }

          wrapper.appendChild(lantern);
          // Ch·ªâ th√™m l·ªìng ƒë√®n v√†o m√†n h√¨nh sau khi ·∫£nh ƒë√£ s·∫µn s√†ng
          lanternContainer.appendChild(wrapper);
        };

        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ·∫£nh b·ªã l·ªói, tr√°nh l√†m treo v√≤ng l·∫∑p
        lanternImgAsset.onerror = () => {
          console.error("L·ªói: kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh l·ªìng ƒë√®n.");
        };

        // Cu·ªëi c√πng, g√°n ngu·ªìn ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i
        lanternImgAsset.src = "lunar.png";
      }
      // --- CLICK HANDLER v·ªõi pixel-check ---
      lanternContainer.addEventListener("click", (e) => {
        const clientX = e.clientX,
          clientY = e.clientY;
        const topEl = document.elementFromPoint(clientX, clientY);
        if (!topEl) return;

        const imgEl =
          topEl.tagName === "IMG" ? topEl : topEl.querySelector("img");
        if (!imgEl) return;

        // ki·ªÉm tra ·∫£nh ƒë√£ load ch∆∞a
        if (!imgEl.complete || imgEl.naturalWidth === 0) {
          console.log("‚è≥ ·∫¢nh ch∆∞a load xong, b·ªè qua click");
          return;
        }

        // check pixel alpha
        const rect = imgEl.getBoundingClientRect();
        const clickX = clientX - rect.left;
        const clickY = clientY - rect.top;

        hitCanvas.width = Math.round(rect.width);
        hitCanvas.height = Math.round(rect.height);
        hitCtx.clearRect(0, 0, rect.width, rect.height);
        hitCtx.drawImage(imgEl, 0, 0, rect.width, rect.height);

        const pixel = hitCtx.getImageData(
          Math.floor(clickX),
          Math.floor(clickY),
          1,
          1
        ).data;
        const alpha = pixel[3];

        if (alpha < 20) {
          // click v√πng trong su·ªët => b·ªè qua
          return;
        }

        const clickedLantern = imgEl.closest(".lantern");
        if (!clickedLantern) return;
        if (clickedLantern.dataset.hasFrame === "true") return;

        // b·ªè ch·ªçn tr∆∞·ªõc ƒë√≥
        document.querySelectorAll(".lantern.selected").forEach((l) => {
          l.classList.remove("selected");
          l.style.animationPlayState = "running";
        });

        clickedLantern.classList.add("selected");
        clickedLantern.style.animationPlayState = "paused";

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const rect = imgEl.getBoundingClientRect();
            const imgCenterX = rect.left + rect.width / 2;
            const imgCenterY = rect.top + rect.height / 2;
            const dx = imgCenterX - window.innerWidth / 2;
            const dy = imgCenterY - window.innerHeight / 2;
            const focusZ = -250;
            lanternContainer.style.transform = `translate3d(${-dx}px, ${-dy}px, ${focusZ}px)`;
            modalDim.classList.add("show");
            setTimeout(() => {
              popupText.textContent = clickedLantern.dataset.message;
              popup.classList.add("active");
            }, 350);
          });
        });
      });

      function closePopup() {
        popup.classList.remove("active");
        modalDim.classList.remove("show");
        lanternContainer.style.transform = `translateZ(-800px)`;
        document.querySelectorAll(".lantern").forEach((l) => {
          l.classList.remove("selected");
          l.style.animationPlayState = "running";
        });
      }

      function closeImagePopup() {
        imagePopup.classList.remove("active");
      }

      popup.addEventListener("click", (e) => {
        if (e.target === popup) closePopup();
      });
      imagePopup.addEventListener("click", (e) => {
        if (e.target === imagePopup) closeImagePopup();
      });

      // m·ªü m√†n ƒë·∫øm ng∆∞·ª£c
      const overlay = document.getElementById("overlay");
      const countdown = document.getElementById("countdown");
      const bgMusic = document.getElementById("bg-music");

      let counter = 3;
      const timer = setInterval(() => {
        counter--;
        if (counter > 0) {
          countdown.textContent = counter;
          countdown.style.animation = "none";
          countdown.offsetHeight; // trigger reflow ƒë·ªÉ reset animation
          countdown.style.animation = null;
        } else {
          clearInterval(timer);
          overlay.classList.add("hidden");
          document.querySelector(".scene").classList.add("start");

          // üéµ Ph√°t nh·∫°c
          bgMusic
            .play()
            .then(() => {
              // üèÆ Cho t·∫•t c·∫£ l·ªìng ƒë√®n b·∫Øt ƒë·∫ßu bay
              document.querySelectorAll(".lantern").forEach((lantern) => {
                lantern.style.animationPlayState = "running";
                lantern.addEventListener("animationend", () => {
                  lantern.style.opacity = 0;
                  lantern.style.animationPlayState = "paused";
                  if (lantern.parentElement) lantern.parentElement.remove();
                });
              });

              // K·∫øt th√∫c s·ª± ki·ªán sau 80 gi√¢y (1 ph√∫t 20 gi√¢y)
              setTimeout(() => {
                const endOverlay = document.createElement("div");
                endOverlay.style.position = "fixed";
                endOverlay.style.inset = 0;
                endOverlay.style.background = "rgba(0, 0, 0, 0.9)";
                endOverlay.style.display = "flex";
                endOverlay.style.flexDirection = "column";
                endOverlay.style.justifyContent = "center";
                endOverlay.style.alignItems = "center";
                endOverlay.style.color = "white";
                endOverlay.style.fontSize = "32px";
                endOverlay.style.zIndex = 30000;
                endOverlay.innerHTML = `
    <div>üéê H·∫øt r·ªìi n√® üéâ</div>
    <div>V√¥ game nh·∫≠n qua nha</div>
    <img src="./Th√™m ti√™u ƒë·ªÅ ph·ª•.png" alt="C·∫£m ∆°n" style="width: 120px; margin-top: 15px;">
  `;
                document.body.appendChild(endOverlay);

                // X√≥a to√†n b·ªô l·ªìng ƒë√®n c√≤n l·∫°i
                document
                  .querySelectorAll(".lantern-wrapper")
                  .forEach((el) => el.remove());
              }, 80 * 1000);
            })
            .catch(() => {});
        }
      }, 1000);
    </script>
  </body>
</html>
